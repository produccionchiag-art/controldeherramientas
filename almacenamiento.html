<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Almacenamiento ‚Äì Austral Group</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; margin:0; }
    header { background:#043366; color:#fff; padding:1em; text-align:center; }
    .content { max-width:95%; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    h2 { color:#043366; margin-top:0; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#043366; color:white; }
    tr:nth-child(even) { background:#f9f9f9; }
    tr:hover { background:#eef6f9; }
    footer { text-align:center; font-size:0.9em; color:#555; margin:20px; }
    .responsables { margin-bottom:20px; padding:15px; background:#eef6f9; border-radius:6px; }
    .responsables h3 { margin-top:0; color:#043366; }
    .responsables ul { padding-left:20px; margin:0; }
    .responsables li::before { content:"üë§ "; }

    /* Evitar cortes de fila en PDF */
    table, tr, td, th {
      page-break-inside: avoid !important;
    }

    .titulo-pdf {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
      color: #043366;
    }

    /* Botones de exportaci√≥n */
    #botones {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    #botones button {
      background: #043366;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    #botones button:hover { background: #0555aa; }

    /* Toast */
    #toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(4,51,102,0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      display: none;
      z-index: 9999;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <header><h1 id="titulo-area">Almacenamiento</h1></header>
  <div class="content" id="content">
    <div id="botones">
      <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
      <button onclick="exportarExcel()">üìä Exportar Excel</button>
    </div>

    <!-- RESPONSABLES arriba -->
    <div class="responsables" id="responsables">Cargando responsables...</div>

    <h2>Gesti√≥n de Herramientas</h2>
    <div id="tabla">Cargando...</div>
  </div>
  <footer id="last-update">√öltima actualizaci√≥n: --</footer>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // Datos actuales mostrados (para exportar)
    window.currentTableData = null;
    window.currentColumns = null;

    function normalizar(texto) {
      return texto
        ? texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase()
        : "";
    }

    function showToast(msg, time = 3000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._timeout);
      t._timeout = setTimeout(() => { t.style.display = 'none'; }, time);
    }

    async function cargar() {
      try {
        const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YNW3jMwhQTz7XVKWANadu5masT9S4IX2fym0vmVXAHgTVJEJtG30o-HvqgDOZw/pub?gid=1232827493&single=true&output=csv";
        const resp = await fetch(url);
        const text = await resp.text();
        const data = Papa.parse(text, { header: true, skipEmptyLines: true }).data;

        const areaBuscada = normalizar("ALMACENAMIENTO");
        const filtradas = data.filter(row => normalizar(row["√ÅREA"]) === areaBuscada);

        if (filtradas.length > 0) {
          // RESPONSABLES (separar por , ; o salto de l√≠nea)
          let responsablesSeparados = [];
          filtradas.forEach(row => {
            if (row["RESPONSABLES"]) {
              const partes = row["RESPONSABLES"]
                .split(/[,;\n]+/)
                .map(r => r.trim())
                .filter(r => r.length > 0);
              responsablesSeparados.push(...partes);
            }
          });

          const responsablesUnicos = [...new Set(responsablesSeparados)].sort();
          if (responsablesUnicos.length > 0) {
            let lista = "<h3>Responsables del √Årea</h3><ul>";
            responsablesUnicos.forEach(r => lista += `<li>${r}</li>`);
            lista += "</ul>";
            document.getElementById("responsables").innerHTML = lista;
          } else {
            document.getElementById("responsables").innerHTML = "<h3>Responsables del √Årea</h3><p>No registrados.</p>";
          }

          // TABLA SIN "√ÅREA" NI "RESPONSABLES"
          const columnas = Object.keys(filtradas[0] || {});
          const columnasFiltradas = columnas.filter(col => col !== "√ÅREA" && col !== "RESPONSABLES");

          // Guardamos columnas y datos para exportar Excel
          window.currentColumns = columnasFiltradas.slice(); // copia
          window.currentTableData = filtradas.map(row => {
            const obj = {};
            columnasFiltradas.forEach(col => { obj[col] = row[col] || ""; });
            return obj;
          });

          // Construir tabla DOM (id tabla-datos)
          let tabla = "<table id='tabla-datos'><thead><tr>";
          columnasFiltradas.forEach(col => { tabla += `<th>${col}</th>`; });
          tabla += "</tr></thead><tbody>";

          filtradas.forEach(row => {
            tabla += "<tr>";
            columnasFiltradas.forEach(col => { tabla += `<td>${row[col] || ""}</td>`; });
            tabla += "</tr>";
          });

          tabla += "</tbody></table>";
          document.getElementById("tabla").innerHTML = tabla;
        } else {
          document.getElementById("responsables").innerHTML = "";
          document.getElementById("tabla").textContent = "‚ö† No hay datos para esta √°rea.";
          // reset global data
          window.currentColumns = null;
          window.currentTableData = null;
        }

        document.getElementById("last-update").textContent =
          "√öltima actualizaci√≥n: " + new Date().toLocaleString();
      } catch (err) {
        console.error(err);
        alert('Error cargando datos: ' + (err.message || err));
      }
    }

    function exportarPDF() {
      const botones = document.getElementById('botones');
      botones.style.display = "none";

      const content = document.getElementById('content');
      const area = document.getElementById('titulo-area').textContent;
      const tituloExtra = document.createElement("div");
      tituloExtra.className = "titulo-pdf";
      tituloExtra.textContent = area;
      content.insertBefore(tituloExtra, content.firstChild);

      const nombreArchivo = area.toLowerCase().replace(/\s+/g, "_") + ".pdf";
      const opt = {
        margin: 0.4,
        filename: nombreArchivo,
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3, useCORS: true },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      html2pdf().set(opt).from(content).save().then(() => {
        tituloExtra.remove();
        botones.style.display = "flex";
        showToast('Descarga PDF completada');
      }).catch(err => {
        tituloExtra.remove();
        botones.style.display = "flex";
        console.error(err);
        alert('Error al generar PDF: ' + (err.message || err));
      });
    }

    function exportarExcel() {
      try {
        const area = (document.getElementById('titulo-area').textContent || 'export').toLowerCase().replace(/\s+/g, "_");
        const nombreArchivo = area + ".xlsx";

        // Preferir datos guardados (m√°s confiable)
        if (window.currentTableData && window.currentTableData.length && window.currentColumns && window.currentColumns.length) {
          const ws = XLSX.utils.json_to_sheet(window.currentTableData, { header: window.currentColumns });
          // ajustar ancho de columnas (opcional, b√°sico)
          const colWidths = window.currentColumns.map(c => ({ wch: Math.max(10, Math.min(30, c.length + 5)) }));
          ws['!cols'] = colWidths;

          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Datos');
          XLSX.writeFile(wb, nombreArchivo);
          showToast('Descarga Excel iniciada: ' + nombreArchivo);
          return;
        }

        // Fallback a tabla DOM
        let tabla = document.getElementById('tabla-datos') || document.querySelector('#tabla table');
        if (!tabla) {
          alert('No hay tabla para exportar.');
          return;
        }
        const wb = XLSX.utils.table_to_book(tabla, { sheet: "Datos" });
        XLSX.writeFile(wb, nombreArchivo);
        showToast('Descarga Excel iniciada: ' + nombreArchivo);
      } catch (err) {
        console.error(err);
        alert('Error al exportar a Excel: ' + (err.message || err));
      }
    }

    // ejecutar carga inicial
    cargar();
  </script>
</body>
</html>
