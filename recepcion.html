<!DOCTYPE html>  
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Recepci√≥n y Pesaje ‚Äì Austral Group</title>
  <style>
    :root {
      --color-principal: #043366;
      --color-secundario: #0a4b99;
      --color-fondo: #f5f7fa;
    }

    body { font-family: Arial, sans-serif; background: var(--color-fondo); margin:0; }
    header { background: var(--color-principal); color:#fff; padding:1em; text-align:center; }
    .content { max-width:95%; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    h2 { color: var(--color-principal); margin-top:0; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background: var(--color-principal); color:white; }
    tr:nth-child(even) { background:#f0f4f8; }
    tr:hover { background:#e6ecf5; }
    footer { text-align:center; font-size:0.9em; color:#555; margin:20px; }
    .responsables { margin-bottom:20px; padding:15px; background:#e6ecf5; border-radius:6px; }
    .responsables h3 { margin-top:0; color: var(--color-principal); }
    .responsables ul { padding-left:20px; margin:0; }
    .responsables li::before { content:"üë§ "; }
    .export-buttons { display:flex; gap:10px; margin:10px 0; }
    .export-buttons button {
      background: var(--color-principal); 
      color:white; 
      border:none; 
      padding:8px 12px;
      border-radius:6px; 
      cursor:pointer; 
      font-size:0.9em;
      transition: background 0.2s ease-in-out;
    }
    .export-buttons button:hover { background: var(--color-secundario); }
  </style>
</head>
<body>
  <header><h1 id="titulo-area">Recepci√≥n y Pesaje</h1></header>
  <div class="content" id="content">
    <!-- RESPONSABLES -->
    <div class="responsables" id="responsables">Cargando responsables...</div>

    <h2>Gesti√≥n de Herramientas</h2>

    <!-- BOTONES DE EXPORTACI√ìN -->
    <div class="export-buttons" id="botones">
      <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
      <button onclick="exportarExcel()">üìä Exportar Excel</button>
    </div>

    <!-- TABLA -->
    <div id="tabla">Cargando...</div>
  </div>
  <footer id="last-update">√öltima actualizaci√≥n: --</footer>

  <!-- Librer√≠as necesarias -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- üìÑ jsPDF + autoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <script>
    function normalizar(texto) {
      return texto
        ? texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim().toUpperCase()
        : "";
    }

    async function cargar() {
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-YNW3jMwhQTz7XVKWANadu5masT9S4IX2fym0vmVXAHgTVJEJtG30o-HvqgDOZw/pub?gid=1232827493&single=true&output=csv";
      const resp = await fetch(url);
      const text = await resp.text();
      const data = Papa.parse(text, { header: true, skipEmptyLines: true }).data;

      const areaBuscada = normalizar("RECEPCION Y PESAJE");
      const filtradas = data.filter(row => normalizar(row["√ÅREA"]) === areaBuscada);

      if (filtradas.length > 0) {
        // RESPONSABLES
        let responsablesSeparados = [];
        filtradas.forEach(row => {
          if (row["RESPONSABLES"]) {
            const partes = row["RESPONSABLES"]
              .split(/[,;\n]+/)
              .map(r => r.trim())
              .filter(r => r.length > 0);
            responsablesSeparados.push(...partes);
          }
        });

        const responsablesUnicos = [...new Set(responsablesSeparados)].sort();
        if (responsablesUnicos.length > 0) {
          let lista = "<h3>Responsables del √Årea</h3><ul>";
          responsablesUnicos.forEach(r => lista += `<li>${r}</li>`);
          lista += "</ul>";
          document.getElementById("responsables").innerHTML = lista;
        } else {
          document.getElementById("responsables").innerHTML = "<h3>Responsables del √Årea</h3><p>No registrados.</p>";
        }

        // TABLA
        const columnas = Object.keys(filtradas[0]);
        const columnasFiltradas = columnas.filter(col => col !== "√ÅREA" && col !== "RESPONSABLES");

        let tabla = "<table id='tabla-datos'><thead><tr>";
        columnasFiltradas.forEach(col => { tabla += `<th>${col}</th>`; });
        tabla += "</tr></thead><tbody>";

        filtradas.forEach(row => {
          tabla += "<tr>";
          columnasFiltradas.forEach(col => { tabla += `<td>${row[col] || ""}</td>`; });
          tabla += "</tr>";
        });

        tabla += "</tbody></table>";
        document.getElementById("tabla").innerHTML = tabla;
      } else {
        document.getElementById("responsables").innerHTML = "";
        document.getElementById("tabla").textContent = "‚ö† No hay datos para esta √°rea.";
      }

      document.getElementById("last-update").textContent =
        "√öltima actualizaci√≥n: " + new Date().toLocaleString();
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

      const area = document.getElementById("titulo-area").textContent;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(4, 51, 102);
      doc.text(area, doc.internal.pageSize.getWidth() / 2, 40, { align: "center" });

      // RESPONSABLES en el PDF
      const listaResponsables = document.querySelectorAll("#responsables li");
      if (listaResponsables.length > 0) {
        doc.setFontSize(12);
        doc.setTextColor(0);
        doc.text("Responsables:", 40, 70);
        let y = 90;
        listaResponsables.forEach(li => {
          doc.text("‚Ä¢ " + li.textContent, 50, y);
          y += 15;
        });
      }

      // TABLA
      const tabla = document.getElementById("tabla-datos");
      if (!tabla) {
        alert("No hay datos para exportar.");
        return;
      }

      const headers = Array.from(tabla.querySelectorAll("thead th")).map(th => th.innerText);
      const rows = Array.from(tabla.querySelectorAll("tbody tr")).map(tr =>
        Array.from(tr.querySelectorAll("td")).map(td => td.innerText)
      );

      doc.autoTable({
        head: [headers],
        body: rows,
        startY: listaResponsables.length > 0 ? 110 + (listaResponsables.length * 15) : 80,
        theme: 'grid',
        styles: { fontSize: 8, cellPadding: 3 },
        headStyles: { fillColor: [4, 51, 102], textColor: [255, 255, 255], fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [240, 244, 248] },
        columnStyles: { 0: { cellWidth: 'auto' } },
        didDrawPage: function (data) {
          doc.setFontSize(10);
          doc.setTextColor(100);
          doc.text(
            "Generado el: " + new Date().toLocaleString(),
            data.settings.margin.left,
            doc.internal.pageSize.height - 10
          );
        }
      });

      doc.save(area.toLowerCase().replace(/\s+/g, "_") + ".pdf");
    }

    function exportarExcel() {
      const tabla = document.getElementById('tabla-datos');
      const wb = XLSX.utils.table_to_book(tabla, { sheet: "Datos" });
      const area = document.getElementById('titulo-area').textContent;
      const nombreArchivo = area.toLowerCase().replace(/\s+/g, "_") + ".xlsx";
      XLSX.writeFile(wb, nombreArchivo);
    }

    cargar();
  </script>
</body>
</html>
